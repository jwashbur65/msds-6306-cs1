---
title: "Analysis"
author: "Lavonnia Newman, Joseph Caguioa, Jeff Washburn"
date: "12/7/2018"
output: 
  html_document:
    theme: default
    highlight: tango
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false

---

```{r setup, include=F, message=F}
knitr::opts_chunk$set(echo = TRUE)

# Install packages if not already installed. Adapted from https://stackoverflow.com/questions/4090169/elegant-way-to-check-for-missing-packages-and-install-them.
list_of_packages <- c("dplyr", "ggplot2", "kableExtra", "knitr", "plyr", "psych", "usmap")
new_packages <- list_of_packages[!(list_of_packages %in% installed.packages()[,"Package"])]
if(length(new_packages)) install.packages(new_packages)

# Load multiple packages at once.
lapply(list_of_packages, library, character.only=TRUE)

```

```{r more_setup, echo=F}
# jquery/DataTable infrastructure for dynamic kable output follows.
# Consider integrating into custom_html.css if time allows.
# Test to see whether this is desired for all instances of kable. Note that activating these deactivates the HTML table of contents for some reason.
```
<link rel="stylesheet" type="text/css" href="http://cdn.datatables.net/1.10.5/css/jquery.dataTables.min.css">
<script src="http://code.jquery.com/jquery-2.1.2.min.js"></script>
<script src="http://cdn.datatables.net/1.10.5/js/jquery.dataTables.min.js"></script>

<script type="text/javascript">
         $(document).ready(function() {
             $("table").DataTable();
         } );
</script>

# Introduction

"The introduction needs to be written as if you are presenting the work to someone who has given you the data to analyze and wants to understand the result. Assume itâ€™s a presentation for a client. This may take some imagination of whom your client might be. If it sounds like a student presentation, that is not acceptable."

# Placeholder. RMarkdown file should contain:
* Formal introduction to client.
* Code explanations as sentences before or after chunks.
* Explicit answers to following 7 questions, given in sentences outside code chunks.
* Project conclusion summarizing findings.

BLAHBLAHBLAH FORMAL INTRODUCTION HERE
... provided us with two data sets:

* Beers.csv: A table of 2,410 US craft beers
* Breweries.csv: A table of 558 US breweries that make those beers
BLAHBLAHBLAH MENTION THAT THE CLIENT GAVE 7 QUESTIONS, SO THESE ARE EXPLICITLY GIVEN IN THE FILE TO MAKE ANSWERS EASIER FOR THEM TO FIND

# Data Input & Cleansing

First, the Beers.csv and Breweries.csv files are loaded into RMarkdown as data frames. Working copies of these data frames, beers_clean and breweries_clean, are created for workflow purposes. Aside from some instances of missing attributes, the data already looks tidy. Certain variables in each data frame are renamed in preparation for merging at a future step.

``` {r clean}

# Initialize by loading data sets.
beers_raw <- read.csv("./Analysis/Beers.csv", header=TRUE, sep=",")
breweries_raw <- read.csv("./Analysis/Breweries.csv", header=TRUE, sep=",")

# Create new working copies.
beers_clean <- data.frame(beers_raw)
breweries_clean <- data.frame(breweries_raw)

# Change column name of brewery ID to match for merging. Differentiate "Name" columns.
names(beers_clean)[names(beers_clean) == "Brewery_id"] <- "Brewery_ID"
names(beers_clean)[names(beers_clean) == "Name"] <- "Beer_Name"
names(breweries_clean)[names(breweries_clean) == "Brew_ID"] <- "Brewery_ID"
names(breweries_clean)[names(breweries_clean) == "Name"] <- "Brewery_Name"

# Change data types of Names to character. Style, City, and State remain factors.
beers_clean$Beer_Name <- as.character(beers_clean$Beer_Name)
breweries_clean$Brewery_Name <- as.character(breweries_clean$Brewery_Name)

```

# Questions of Interest:
## 1. How many breweries are present in each state? 

The number of breweries present in each state can be ascertained from the breweries_clean data frame (effectively directly from Breweries.csv). Each occurrence of the state's abbreviation under the State column is interpreted as the corresponding brewery being located in the state. Therefore, we can count how many times the abbreviation appears to obtain the number of breweries in that state.

``` {r number_of_breweries_1}

# Count instances of state using count() from plyr.
breweries_count_state <- count(breweries_clean, "State")
names(breweries_count_state)[names(breweries_count_state) == "freq"] <- c("Num_Breweries")

# Choropleth map using usmap library, which returns ggplot objects. First clean state column to meet plot_usmap() argument requirements.
breweries_count_state$State <- trimws(breweries_count_state$State)
breweries_count_state$State <- as.character(breweries_count_state$State)
names(breweries_count_state)[names(breweries_count_state) == "State"] <- c("state")

# Then, create choropleth map.
bcs_choro <- plot_usmap(data = breweries_count_state, values = "Num_Breweries", 
                        lines = "brown") +
  ggtitle("Number of Breweries Per State") +
  scale_fill_continuous(
    name = "Number of Breweries",
    low = "white", high = "orange") +
  theme(
    legend.position="bottom",
    plot.title = element_text(hjust = 0.5))
bcs_choro

```

The above choropleth map provides a visual look at the number of breweries present in each state. Darker shading indicates more breweries. Note that the flat number of breweries is used for the entire state, and it is not adjusted by density or in terms of landmass, population, or location within the state.

```{r number_of_breweries_2, echo=F, results="hide"}

# Bar graph for all 50 states plus DC. Table output and choropleth map favored. An early placeholder visualization hidden in the final html document.
bcs_bars <- breweries_count_state %>% ggplot(aes(x = reorder(state, Num_Breweries), y = Num_Breweries)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  ggtitle("Number of Breweries Per State") +
  xlab("State") +
  ylab("Number of Breweries") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.ticks = element_blank()
        )

```

``` {r number_of_breweries_3}

# Kable output for breweries in each state.
kable(breweries_count_state,
      col.names = c("State",
                    "Number of Breweries"),
      caption="Number of breweries in each state (and Washington DC):",
      table.attr="style='width:30%;'") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

HOLD: NOTE THAT THE TABLE CANNOT BE SORTED IF THE JQUERY/DATATABLE COMMANDS ARE INACTIVE. THOSE CONFLICT WITH THE TOC FOR SOME REASON. (REWRITE THE PORTION OF THE FOLLOWING ANSWER THAT REFERENCES IT.)

This table provides the exact numbers. Its default setting has it sorted in descending alphabetical order by state abbreviation, but it can also be sorted by the number of breweries. The table can be queried for any particular state, but the following details are notable:

* Colorado has the most breweries, 47. It is the only state in this data set containing more than 40 breweries.
* California (39), Michigan (32), Oregon (29), and Texas (28) round out the rest of the top five.
* Each state has at least one brewery in the data set.
* North Dakota, South Dakota, Washington DC, and Wyoming are tied for the least breweries, with one apiece.

## 2. Merge beer data with breweries data. 

The breweries and beers in these data sets have a one-to-many relationship; each brewery can produce multiple beers, but each beer is only linked to a single brewery. Both data sets share brewery ID as a common variable, so it can be used to merge the breweries data set into the beers data set for further analysis.

```{r merge}

# Merge data sets using shared Brewery_ID column.
merged_beers_raw <- merge(beers_clean, breweries_clean, by = c("Brewery_ID", "Brewery_ID"), all = TRUE)

# Reorder columns: all beer-related variables, then all brewery-related variables.
merged_beers_raw <- merged_beers_raw[c("Beer_Name", "Beer_ID", "ABV", 
                               "IBU", "Style", "Ounces",
                               "Brewery_Name", "Brewery_ID", "City", "State")]

# Check merged file by printing first and last six observations.
kable(head(merged_beers_raw, 6), 
      caption="First 6 Rows of Merged Data",
      row.names = T) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
kable(tail(merged_beers_raw, 6), 
      caption="Last 6 Rows of Merged Data",
      row.names = T) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

The first and last six observations are printed to show that the merge was successful. Note that because the brewery ID was used as the merging column, the merged data frame is sorted in ascending order by that variable. Brewery_ID = 1 appears for the first six rows, while Brewery_ID = 558 appears in the final row of the last six, 558 being the number of breweries in the original Breweries.csv file. Furthermore, the row numbers for the last six observations indicate that all 2,410 craft beers from the original Beers.csv file made it into this merged data frame.

## 3. Report number of NAs in each column.

The above table of the last six observations displays "NA," or not available, for the IBU variable, indicating that those beers are missing IBU values. Knowing whether or not a variable is missing values is important because unless the NAs are explicitly ignored, some functions in R will return NA as an answer if NA occurs even once.

```{r numnas}

# Report the number of NAs in each column.
num_nas <- colSums(is.na(merged_beers_raw))
kable(num_nas, 
      col.names = c("Number of NAs"),
      caption="Number of NAs Per Column",
      table.attr="style='width:30%;'") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

Any instances of NA are counted and reported in this table, which shows that only the ABV and IBU columns contain NAs, with 62 and 1005, respectively. All other variables contain data.

## 4. Compute median alcohol content and international bitterness unit for each state. 
Plot a bar chart to compare.

```{r medians_state}
#Calculating the median and ignoring NA
abv_state_median<-aggregate(merged_beers_raw$ABV, list(merged_beers_raw$State), median, na.rm=TRUE)
ibu_state_median<-aggregate(merged_beers_raw$IBU, list(merged_beers_raw$State), median, na.rm=TRUE)

names(abv_state_median)<-c("State", "Median ABV")
names(ibu_state_median)<-c("State", "Median IBU")
```
### 4.1 ABV Median
``` {r}
#Output the results
kable(abv_state_median, format="markdown", caption="Median ABV For Each State")
```
### 4.2 IBU Median
``` {r}
kable(ibu_state_median, format="markdown", caption="Median IBU For Each State")
```

## 5. Which state has the most alcoholic beer by ABV? Most bitter beer by IBU? 
(Consider bar chart again, with top [5/10] in each category. However, highlight the number 1.)
```{r "abv-ibu echo=TRUE"}
abv_max <- max(merged_beers_raw$ABV, na.rm=TRUE)
ibu_max <- max(merged_beers_raw$IBU, na.rm=TRUE)
abv_max
ibu_max

#Convert State from Factor to Character
merged_beers_raw$State <- as.character(merged_beers_raw$State)

#Determine the highest ABV in each State (return by State)
abv.agg <- aggregate(ABV ~ State, merged_beers_raw, max)

#Now Sort the states by ABV descending
sorted_abv_agg<-abv.agg %>% arrange(desc(ABV))
first_ten_abv<-head(sorted_abv_agg, 10)
kable( head(first_ten_abv, 10), format="markdown", caption="Top 10 State ABV Values")


#Determine the highest IBU in each State (return by State)
ibu.agg <- aggregate(IBU ~ State, merged_beers_raw, max)

#Now Sort the states by IBU descending
sorted_ibu_agg<-ibu.agg %>% arrange(desc(IBU))
kable( head(sorted_ibu_agg, 10), format="markdown", caption="Top 10 State IBU Values")


#Now let's graph ABV (top 10)
abv_beers <- first_ten_abv %>% ggplot(aes(x= reorder(State, desc(ABV)), y = ABV)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  ggtitle("States by ABV") +
  xlab("State") +
  ylab("ABV") +
  theme(plot.title = element_text(hjust = 0.5), axis.ticks = element_blank()) + 
  theme(axis.text.x = element_text(angle = -90))
abv_beers
```

## 6. Summary statistics for ABV (and IBU).
```{r "abv-summary-stats echo=TRUE"}

# summary() shows five-number summary, mean, and NAs.
summary(merged_beers_raw$ABV)
summary(merged_beers_raw$IBU)

# Five-number summary can also be displayed in a boxplot.
ggplot(merged_beers_raw, aes(x="", y=ABV)) +
  geom_boxplot() +
  ggtitle("Placeholder ABU boxplot")
ggplot(merged_beers_raw, aes(x="", y=IBU)) +
  geom_boxplot() +
  ggtitle("Placeholder IBU boxplot")

```

## 7. Is there a relationship between IBU and ABV? 
Draw a scatterplot. (Use linear regression to quantify the relationship, provide R^2.)
```{r "IBU-to-ABV echo=TRUE"}
abv_ibu_scatter <-
 merged_beers_raw %>% ggplot(aes(x = ABV, y = IBU)) +
 geom_point(na.rm = TRUE, alpha = 0.5, col="#F19800") +
 xlab("Alcohol By Volume (ABV)") +
 ylab("International Bitterness Units (IBU)") +
 ggtitle("Relationship Between Beerâ€™s\nBitterness and Alcoholic Content") +
 # Test with both method="lm" and ="loess" for linear and smooth regressions.
 geom_smooth(method = "lm", se = TRUE, level = 0.95,
             aes(color = "CC720C", fill = "#F28E1C")
             ) +
 theme(plot.title = element_text(hjust = 0.5),
       axis.ticks = element_blank()
       )
abv_ibu_scatter
```
Results - There appears to be a positive correlation between ABV and IBU.  The higher the alcoholic content (ABV) the higher the bitterness (IBU).  

(WE CAN ALSO DO A PEARSON'S R FOR ABV~IBU AND COEFFICIENT OF DETERMINATION FOR THE GRAPH'S BEST-FIT LINEAR REGRESSION LINE)

``` {r correlation}

# Use cor() from base stats to calculate Pearson correlation coefficient.
r <- cor(merged_beers_raw$ABV, merged_beers_raw$IBU, 
         use = "pairwise.complete.obs",
         method = "pearson")

# Square Pearson's r to obtain coefficient of determination.
R_2 <- r^2

# Present r and R_2.
r
R_2

```

# Additional Analysis
  
## Style Analysis

```{r style_analysis}

# General counts of beer styles. Obtain top 20 by brewing frequency.
beers_count_style <- count(merged_beers_raw, "Style")
names(beers_count_style)[names(beers_count_style) == "freq"] <- c("Style_Count")
beers_count_style_sorted <- beers_count_style %>% arrange(desc(Style_Count))
beers_count_style_sorted_top20freq <- beers_count_style_sorted[1:20, ]

# Total number of beer styles is 100.
num_styles <- n_distinct(beers_count_style$Style)
cat("The original data contains ", num_styles, " unique beer styles.")
# num_styles_check <- n_distinct(beers_raw$Style)
# cat("The raw version of beers contains ", num_styles_check, " unique beer styles. Does this match the other statement?")

kable(beers_count_style_sorted_top20freq, format="markdown", caption="The Top 20 Beer Styles by Frequency")

# Bar graph visualization.
style_bars <- beers_count_style_sorted_top20freq %>% ggplot(aes(x = reorder(Style, Style_Count), y = Style_Count)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  ggtitle("Top 20 Styles by Frequency") +
  xlab("Style") +
  ylab("Beers Per Style") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.ticks = element_blank()
        )
style_bars

```

## Brewery Analysis

```{r brewery_analysis}
# Count instances of Brewery_Name to figure out how many beers each brewery makes.
beers_in_brewery <- count(merged_beers_raw, "Brewery_Name")
names(beers_in_brewery)[names(beers_in_brewery) == "freq"] <- c("Beer_Count")
beers_in_brewery <- beers_in_brewery %>% arrange(desc(Beer_Count))
beers_in_brewery_top20freq <- beers_in_brewery[1:20, ]
kable(beers_in_brewery_top20freq, format="markdown", caption="The Top 20 Breweries by Number of Unique Beers Brewed")

# merge the raw beers with the beers in brewery count
# merged_beers_raw <- merge(beers_clean, breweries_clean, by = c("Brewery_ID", "Brewery_ID"), all = TRUE)
merged_beers_prime_1 <- merge(beers_in_brewery, merged_beers_raw[, 7-10], by = c("Brewery_Name"), all = FALSE)
merged_beers_prime_2 <- merged_beers_prime_1 %>% arrange(desc(Beer_Count))
kable(merged_beers_prime_2, format="markdown")

# #Create a dataframe with just the Name and FT percentagerawfreeThrows<- data.frame(myspurs[2:nrow(myspurs),c(1,10)])
```

# Conclusion

"Summarize your findings from this exercise."

# Storyline
## Notes
* Concept
  + Dr Cheun is an established bar owner, looking to open a new bar(s) across the U.S.  We are an analysist firm helping Dr. Cheun open bars.  
  + She is looking for:
    + Open a new bar, that has easy access to most breweries for the type of beers to target certain customers
    + Types of beer (look at "The Top 20 Beer Styles by Frequency" chart below)
    + Bar location (Dr. Cheun is based out of Nevada, we think you should not open up a new bar here)
    + Range of beer (which beers to have on tap)
    + Need to map current locations of her existing bars (to reconfirm current selection of beers against consumer base)
      + We analyzed our beers from ABV and IBU content and matched up the best selection based on your store location.
      + Beer xzy would do good here vs, beer def will do better in your TX bar because they like to get drunk quick
    + Demographics of this state is mostly xyz, and found this beer is a good fit for this abc beer
* Company Name
  + SM-Brew (new name in the works)
* Call out that Dr Cheun is the client (gave use the data to be analyzed) and we are the vendor/sales/ folks that took data, cleaned, merged it, made sense of it
  + 2 data files provided, had to merge them. 
  + in IBU and ABV, there was x number of these when we merged them by beers across states, there was x number of NAs for number of beers.  
  + We cleaned some things
* Content that must be worked into storyline
  + #1 Breweries per state
  + #4 Median ABV and IBU per state
  + #5 State w/ max ABV beer and most bitter 
  + #6 Summary statistic for ABV
  + #7 Relationship between ABV and IBU
* Cast
  + Dr. Cheun investor 

## Intro (2 mins)
*  Dr Cheun is an established bar owner, looking to open a new vegan bar across the U.S. to cator to the lack of choices vegatarians have when it comes to entertainment and social nightlife.  We are an analysist firm helping Dr. Cheun to choose the best location based on brewery logistics/distribution, alcoholic content/bitterness (use the relationship between bitterness and alcoholic content), and lastly the style of beer 

*  Our goal is to help you determine the best location and best bang for your buck on opening the new location based on the type of beer currently sold in the area to maximize drunkeness
* 

### Point 1 (4 mins)
* best location based on brewery logistics/distribution
  + Current logistics of brewery locations vs best possible bar opening location (reduce beer distribution cost)
  + based on Dr Cheun's current beer locations, it makes sense (from brewery location) to open bar in these 4 possible states
  + Current breakdown of breweries across the state (need table/chart)
  
* There are tax incentives to go with breweries that are located in the following 5 states (or, tx, nv, idaho).

* The East coast cost is extremely high and are recommending that the bar remain in the central/west region

### Point 2 (4 mins)
* alcoholic content/bitterness 
  + (use the relationship between bitterness and alcoholic content graph)
  + Based on the comparison of ABV and ounces per beer.  
  + First we looked the ABV median per state (4.1)
  + Then we looked the IBU median per state (4.2) determined that 
  
* We found that people like a good mix between bitterness and alcholic content.  We also found that the higher the alcolohic content, the more the person would drink

* We recommend a higher content beer


### Point 3 (4 mins)
* style of beer
  + We researched the styles of beer across the united states (show the table of Top 20 beer styles by frequency)

## Conclusion (2 mins)
From the information provided, we conclude that you should open a vegan bar in Paris, TX with the following beers offered x, y, z, which you would purchase from breweries (x, y, and z) to reduce your liability of being tied to 1 brewery 

```{r test}

texas <- subset(merged_beers_raw, State = 44, select = c("Beer_Name", "ABV", "IBU", "Style", "Brewery_Name", "City", "State"))


```
